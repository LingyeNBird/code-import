# error-handling Specification

## Purpose
本规范定义了 CNB Code Import 工具中的错误处理和容错机制。主要关注外部 API 调用失败时的重试策略、优雅降级行为和日志记录规范,确保迁移流程在遇到暂时性故障时能够自动恢复,在无法恢复时能够继续处理其他仓库而不中断整个迁移过程。
## Requirements
### Requirement: Coding API 重试机制
系统 SHALL 对失败的 CODING API 调用进行最多3次重试,使用指数退避策略,然后才将失败视为最终失败。

#### Scenario: 第一次尝试成功的 API 调用
- **假设** CODING API 可访问并返回有效的项目信息
- **当** `CodingVcs.GetSubGroup()` 调用 `coding.GetProjectByName()`
- **那么** 该方法必须返回完整的 `SubGroup`,其中 `Name`、`Desc` 和 `Remark` 字段已填充
- **并且** 不得生成警告或错误日志
- **并且** 不得发生重试尝试

#### Scenario: API 调用在第二次尝试成功
- **假设** 第一次 API 调用因暂时性网络错误而失败
- **并且** 第二次 API 调用成功
- **当** 调用 `CodingVcs.GetSubGroup()`
- **那么** 该方法必须在第一次失败后等待1秒
- **并且** 该方法必须重试 API 调用
- **并且** 该方法必须为第一次失败记录 WARN 级别消息,格式为:`"获取项目 %s 信息失败 (尝试 1/3): %v"`
- **并且** 该方法必须在成功重试后返回完整的 `SubGroup`

#### Scenario: API 调用在第三次尝试成功
- **假设** 前两次 API 调用失败
- **并且** 第三次 API 调用成功
- **当** 调用 `CodingVcs.GetSubGroup()`
- **那么** 该方法必须在第一次失败后等待1秒
- **并且** 该方法必须在第二次失败后等待5秒
- **并且** 该方法必须重试 API 调用两次
- **并且** 该方法必须为两次失败都记录 WARN 级别消息
- **并且** 该方法必须在第三次尝试成功后返回完整的 `SubGroup`

#### Scenario: 所有重试尝试都用尽
- **假设** 所有三次 API 调用尝试都失败并返回错误
- **当** `CodingVcs.GetSubGroup()` 完成所有重试
- **那么** 该方法必须记录 WARN 级别消息,格式为:`"获取项目 %s 信息最终失败,已重试3次,仅使用项目名称继续迁移: %v"`
- **并且** 最终日志消息必须包含最后一次尝试的完整错误详情
- **并且** 该方法必须返回最小的 `SubGroup`,仅填充 `Name` 字段
- **并且** `Desc` 和 `Remark` 字段必须是空字符串
- **并且** 该方法不得 panic 或终止程序
- **并且** 该方法不得返回错误

### Requirement: API 失败时的优雅降级
即使 CODING API 调用在所有重试尝试后失败,系统 SHALL 继续迁移流程。

#### Scenario: API 失败后迁移继续
- **假设** 由于 API 失败,`CodingVcs.GetSubGroup()` 返回了最小的 `SubGroup`
- **当** 迁移流程继续处理后续仓库
- **那么** 其他仓库必须正常处理
- **并且** 失败项目的仓库仍必须使用默认子组织元数据进行迁移
- **并且** 程序不得退出或终止

#### Scenario: 失败时 SubGroup 仅包含项目名称
- **假设** 项目 "MyProject" 的所有 API 重试尝试都失败
- **当** `CodingVcs.GetSubGroup()` 返回 `SubGroup`
- **那么** 返回的 `SubGroup.Name` 必须等于 "MyProject"
- **并且** 返回的 `SubGroup.Desc` 必须是空字符串(不包含错误消息)
- **并且** 返回的 `SubGroup.Remark` 必须是空字符串(不是 "ERROR")

### Requirement: 重试时间配置
系统 SHALL 在连续的 API 调用尝试之间使用固定的重试间隔:1秒、5秒和10秒。

#### Scenario: 重试尝试之间的时间间隔
- **假设** 第一次 API 调用在时间 T0 失败
- **当** 重试机制执行
- **那么** 第二次尝试必须在大约 T0 + 1秒时发生
- **并且** 如果第二次尝试失败,第三次尝试必须在大约 T0 + 6秒时发生(1秒 + 5秒)
- **并且** 如果第三次尝试失败,不得再进行进一步的重试

### Requirement: API 失败的结构化日志
系统 SHALL 使用结构化信息记录 API 失败,包括项目名称、尝试次数和错误详情。

#### Scenario: 重试尝试的日志消息格式
- **假设** 在重试尝试 N 期间 API 调用失败
- **当** 生成警告日志
- **那么** 日志级别必须是 WARN
- **并且** 日志消息必须包含项目名称
- **并且** 日志消息必须包含当前尝试次数(从1开始)
- **并且** 日志消息必须包含总尝试次数(3)
- **并且** 日志消息必须包含来自 API 调用的完整错误消息
- **并且** 日志消息格式必须是:`"获取项目 %s 信息失败 (尝试 %d/3): %v"`

#### Scenario: 最终失败的日志消息格式
- **假设** 所有三次 API 重试尝试都已失败
- **当** 生成最终警告日志
- **那么** 日志级别必须是 WARN(不是 ERROR)
- **并且** 日志消息必须清楚地表明这是最终失败
- **并且** 日志消息必须说明迁移将使用有限的元数据继续
- **并且** 日志消息必须包含重试尝试的总次数(3)
- **并且** 日志消息必须包含最后一次尝试的完整错误详情
- **并且** 日志消息格式必须是:`"获取项目 %s 信息最终失败,已重试%d次,仅使用项目名称继续迁移: %v"`

