# 提案: 自动修剪仓库描述的前后空格

**变更ID:** `trim-repo-description-spaces`  
**状态:** 提案  
**创建时间:** 2026-01-27

## 问题描述

在迁移仓库到 CNB 平台时,如果仓库描述的开头或末尾包含空格字符,创建过程会失败。CNB API 会返回错误码 3,错误信息为: `"Description cannot begin or end with space"`。

**日志证据:**
```
仓库创建失败: request failed with status code 400: {"errcode":3,"errmsg":"Description cannot begin or end with space"}
```

这个问题的原因是源平台(CODING、GitHub、GitLab 等)允许仓库描述带有前后空格,但 CNB 平台有更严格的验证规则。当前工具只会截断超过 `RepoDescLimitSize`(350字符)的描述,但不会清理空格。

**影响范围:**
- 带有前后空格描述的仓库迁移失败
- 需要人工干预修复这些仓库
- 不同源平台的用户体验不一致

## 解决方案

在 CNB 平台创建仓库之前,自动修剪仓库描述的前后空格。这样可以确保与 CNB 验证规则兼容,同时保留描述的有意义内容。

**关键变更:**
1. 在 `pkg/api/target/api.go` 的 `CreateRepo` 函数中添加清理逻辑,修剪 `repoDesc` 参数的前后空格
2. 更新数据清理规范以记录此行为
3. 添加测试验证空格修剪功能正常工作

**设计原则:**
- **透明性**: 自动修剪,无需用户配置
- **保守性**: 仅删除前后空格;保留内部空格和内容
- **一致性**: 对所有仓库应用相同的清理规则,无论来源平台
- **最小化**: 仅影响描述字段,不影响其他元数据

## 备选方案

1. **在 VCS 接口层验证**: 在每个 `GetRepoDescription()` 实现中修剪
   - **拒绝原因**: 需要在 10+ 个平台实现中修改;更容易出错
   
2. **拒绝无效描述的仓库**: 用清晰的错误消息使迁移失败
   - **拒绝原因**: 增加摩擦;用户必须手动修复源仓库后重新运行迁移
   
3. **添加配置标志**: 通过配置使修剪可选
   - **拒绝原因**: 增加不必要的复杂性;修剪总是安全且可取的

## 依赖关系

- 无。这是一个独立的变更。

## 风险与缓解措施

| 风险 | 严重程度 | 缓解措施 |
|------|----------|------------|
| 修剪可能删除有意的空格 | 低 | 描述中的前后空格几乎总是无意的;修剪可以提高数据质量 |
| 现有测试可能假定原始空格 | 低 | 如需要,审查并更新测试断言 |
| 可能隐藏源数据中的验证问题 | 低 | 如果修剪了空格,记录警告日志(可选增强) |

## 成功标准

1. 带有前后空格的描述能成功创建仓库
2. 现有迁移流程无功能回归
3. 单元测试验证修剪行为
4. 文档更新以反映清理行为

## 相关变更

- 与 error-handling 规范相关(优雅降级模式)
- 可能为其他字段的未来清理需求提供参考(组织名称、仓库名称等)
